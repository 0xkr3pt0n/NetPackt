{% extends "core/dashboard.html" %} {%block title%}{{report.1}}{%endblock%}
{%block dashboard_content%} {%load static%}
<main>
  <div class="container-fluid px-4">
    <h1 class="mt-4">Report of {{report.1}}</h1>
    <ol class="breadcrumb mb-4">
      <li class="breadcrumb-item"><a href="{%url 'home'%}">Dashboard</a></li>
      <li class="breadcrumb-item"><a href="{%url 'scans'%}">Scans</a></li>
      <li class="breadcrumb-item active">{{report.1}}</li>
    </ol>

    <div class="row">
      <!-- Vulnerabilities Table -->
      <div class="col-lg-6">
        <div class="card mb-2">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span>Scan Information</span>
            <span id="editScanNameIcon" data-toggle="modal" data-target="#editScanNameModal">
              <i class="fas fa-pen"> </i>
            </span>
          </div>
          <div class="card-body">
            <ul class="list-group">
              <li class="list-group-item"><b>Scan Name :</b> {{report.1}}</li>
              <li class="list-group-item"><b>Target IP :</b> {{report.2}}</li>
              <li class="list-group-item"><b>Done By :</b> {{report.3}}</li>
              <li class="list-group-item"><b>Shared With :</b> {{report.4}}</li>
              <li class="list-group-item"><b>Scan Date :</b> {{report.5}}</li>
              <li class="list-group-item"><b>Status :</b> {{report.6}}</li>
            </ul>
          </div>
        </div>
        <div class="card mb-4">
          <div class="card-header">
            <i class="fas fa-table me-1"></i>
            Scan result summary
          </div>
          <div class="card-body">
            <table class="table table-striped">
              <thead>
                <tr>
                  <th>Port number</th>
                  <th>Running service</th>
                  <th>Service Version</th>
                </tr>
              </thead>
              <tbody>
                {%for result_item in scan_result%}
                <tr>
                  <td>{{result_item.5}}</td>
                  <td>{{result_item.2}} {{result_item.3}}</td>
                  <td>{{result_item.4}}</td>
                </tr>
                {%endfor%}
                <!-- Add more rows for other vulnerabilities -->
              </tbody>
            </table>
          </div>

        </div>
      </div>

      <!-- Pie Chart -->
      <div class="col-lg-6 mt-5">
        <div class="card mb-4">
          <div class="card-header">
            <i class="fas fa-chart-pie me-1"></i>
            Sytem Imapcts
          </div>
          <div class="card-body">
            <canvas id="myPieChart" width="100%" height="50"></canvas>
          </div>
          <div class="card-footer small text-muted">
            Updated yesterday at 11:59 PM
          </div>
        </div>
        <div class="card mb-4">
          <div class="card-header">
            <i class="fas fa-table me-1"></i>
            Threats Detected Summary
          </div>
          <div class="card-body">
            <table class="table table-striped">
              <thead>
                <tr>
                  <th>Infected Service</th>
                  <th>Impact</th>
                  <th>CVE-ID</th>
                </tr>
              </thead>
              <tbody>
                {%for finding in findings%}
                <tr>
                  <td>{{finding.3}}</td>
                  <td>{{finding.17}}</td>
                  <td>{{finding.1}}</td>
                </tr>
                {%endfor%}
                {%for find in online%}
                <tr>
                  <td>{{find.5}}</td>
                  <td>{{find.7}}</td>
                  <td>{{find.4}}</td>
                </tr>
                {%endfor%}
                <!-- Add more rows for other vulnerabilities -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

{% comment %} detilied report start {% endcomment %}
<div class="card mb-4">
  <div class="card-header">
    <i class="fas fa-chart-area me-1"></i>
    Detailed report
  </div>
  <div class="card-body p-3">
    {%for scan_item in scan_result%}
      <div class="card mb-3">
        <div class="card-header">
          Port : {{scan_item.5}}
        </div>
        <div class="card-body">
          <ul class="list-group">
            <li class="list-group-item"><b>Running Service :</b> {{scan_item.2}} {{scan_item.3}}</li>
            <li class="list-group-item"><b>Service Version :</b> {{scan_item.4}}</li>
            <li class="list-group-item"><b>Scripts result : </b> <br>
              {{scan_item.6}}
            </li>
            {%if is_online == 0 %}
            <li class="list-group-item"><b>Vulnerabilities Found : </b> <br>
              <ul class="list-group list-unstyled">
              {%for finding in findings%}
                {% if finding.4 == scan_item.5 %}
                <li class="list-group-item"><b>CVE ID :</b> {{finding.1}}</li>
                <li class="list-group-item"><b>Severity Impact :</b> {{finding.17}}</li>
                <li class="list-group-item"><b>Exploitability :</b> 
                  {%if finding.5%}
                    <p>
                      Easy,
                      Exploit available online an attacker with low knowledge could exploit it, It's recommended to batch it as soon as possible
                    <p>
                  {%else%}
                    <p>
                      Hard,
                      Exploit isn't available online it requires high knowledge to exploit it, it's not time critical to batch this vulnerability However it should be fixed as soon as possible.
                    </p>
                  {%endif%}
                </li>
                {%if finding.5%}
                  {%for exploit_link in finding.6%}
                    <li class="list-group-item"><b>Exploit Links:</b> 
                      <a href="{{exploit_link}}" target="_blank">{{exploit_link}}</a>
                    </li>
                  {%endfor%}
                {%endif%}
                <li class="list-group-item"><b>Description :</b> {{finding.12}}</li>
                <li class="list-group-item"><b>Refrences :</b> 
                  {%for ref in finding.18%}
                <ul>
                  <li><a href="{{ref}}" target="_blank">{{ref}}</a></li>
                </ul>
                {%endfor%}
                </li>
                {%endif%}
                
                {%endfor%}
                {%endif%}
                {%if is_online == 1%}
                <li class="list-group-item">
                  <ul class="list-group list-unstyled">
                  {%for find in online%}
                  {%if find.8 == scan_item.5%}
                    <li class="list-group-item"><b>CVE ID :</b> {{find.4}}</li>
                    <li class="list-group-item"><b>Severity Impact :</b> {{find.7}}</li>
                    <li class="list-group-item"><b>Exploitability :</b>
                      {%if find.9%}
                        <p>
                          Easy,
                          Exploit available online an attacker with low knowledge could exploit it, It's recommended to batch it as soon as possible.
                        </p>
                        
                        <li class="list-group-item"><b>Exploit Links:</b> 
                          <a href="{{find.10}}" target="_blank">{{find.10}}</a>
                        </li>
                      
                      </li>
                      {%else%}
                        <p>
                          Hard,
                          Exploit isn't available online it requires high knowledge to exploit it, it's not time critical to batch this vulnerability However it should be fixed as soon as possible.
                        </p>
                      </li>
                      {%endif%}
                      

                    
                    <li class="list-group-item"><b>Description :</b> {{find.1}}</li>
                    <li class="list-group-item"><b>Refrences : </b> <br>
                      {%for ref in find.3%}
                      <ul>
                        <li><a href="{{ref}}" target="_blank">{{ref}}</a></li>
                      </ul>
                      {%endfor%}
                    </li>
                  {%endif%}
                  {%endfor%}
                  </ul>
                </li>
                <hr>
                {%endif%}
            
          </ul>
        </div>
      </div>
    {%endfor%}
  </div>
</div>
{% comment %} detilied report end {% endcomment %}
</main>
<script src="{%static 'chart.js'%}"></script>

<!-- Modal for editing scan name -->
<div
  class="modal fade"
  id="editScanNameModal"
  tabindex="-1"
  role="dialog"
  aria-labelledby="editScanNameModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editScanNameModalLabel">
          Edit Scan Details
        </h5>
        <button
          type="button"
          class="close"
          data-dismiss="modal"
          aria-label="Close"
        >
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <!-- Form for editing scan name -->
        <form id="editScanNameForm" method="POST">
            {% csrf_token %}
          <div class="form-group">
            <label for="newScanName">Scan Name:</label>
            <input
              type="text"
              class="form-control"
              id="newScanName"
              name="new_name"
              value="{{report.1}}"
            />
            <div class="form-group">
              <label for="sharedwith">Shared with:</label>
              <div class="input-group">
                <input
                  type="text"
                  class="form-control"
                  id="shared_with"
                  name="new_share"
                  value="{{report.4}}"
                />
                <div class="input-group-append">
                  <div class="dropdown">
                    <button
                      class="btn btn-secondary dropdown-toggle"
                      type="button"
                      id="shareDropdownButton"
                      data-toggle="dropdown"
                      aria-haspopup="true"
                      aria-expanded="false"
                    >
                      Share with
                    </button>
                    <div
                      class="dropdown-menu"
                      aria-labelledby="shareDropdownButton"
                    >
                      {% for user in users %}
                      <a class="dropdown-item" href="#" data-value="{{user.0}}"
                        >{{user.0}}</a
                      >
                      {% endfor %}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- JavaScript code to handle the form submission (assuming you want to handle the form submission) -->
<script>
  document
    .getElementById("editScanNameForm")
    .addEventListener("submit", function (event) {
      // Handle form submission here
      // You can use AJAX to send the form data to the server or perform other actions
      // Close the modal after form submission
      $("#editScanNameModal").modal("hide");
    });

  document.addEventListener("DOMContentLoaded", function () {
    // Get the dropdown items
    var dropdownItems = document.querySelectorAll(".dropdown-item");

    // Get the input element
    var sharedWithInput = document.getElementById("shared_with");

    // Add click event listeners to the dropdown items
    dropdownItems.forEach(function (item) {
      item.addEventListener("click", function () {
        // Get the selected value
        var selectedValue = item.getAttribute("data-value");

        // Get the current input value
        var currentValue = sharedWithInput.value;

        // Check if the input is not empty, add a comma before the new value
        if (currentValue !== "") {
          currentValue += ", ";
        }

        // Update the input value with the selected value
        sharedWithInput.value = currentValue + selectedValue;
      });
    });
  });
  
  var noneCount = 0;
  var highCount = 0;
  var mediumCount = 0;
  var lowCount = 0;

  {%if is_online == 1%}
    {%for find in online%}
      {% if find.7 == 'None' %}
        noneCount++;
      {% elif find.7 == 'HIGH'%}
        highCount++;
      {% elif find.7 == 'MEDIUM' %}
        mediumCount++;
      {% elif find.7 == 'LOW' %}
        lowCount++;
      {% endif %}
    {%endfor%}
 
  // Iterate through findings and count occurrences of impact levels
  {%else%}
    {% for finding in findings %}
      {% if finding.17 == 'None' %}
          noneCount++;
      {% elif finding.17 == 'High'%}
          highCount++;
      {% elif finding.17 == 'Medium' %}
          mediumCount++;
      {% elif finding.17 == 'Low' %}
          lowCount++;
      {% endif %}
    {% endfor %}
  {%endif%}


  var chardata = [noneCount, highCount, mediumCount, lowCount];
  drawchart(chardata);
</script>
{%endblock%}
